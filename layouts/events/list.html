{{ define "main" }}
{{ partial "page-header.html" . }}

<!-- Events Listing -->
<section class="section events-listing-section">
  <div class="container">
    <!-- View Toggle and Filters -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="events-controls d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
          <div class="view-toggle mb-3 mb-md-0">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary active" id="listViewBtn" data-view="list">
                <i class="fas fa-list me-2"></i>List View
              </button>
              <button type="button" class="btn btn-outline-primary" id="calendarViewBtn" data-view="calendar">
                <i class="fas fa-calendar-alt me-2"></i>Calendar View
              </button>
            </div>
          </div>
          <div class="events-filters-container flex-grow-1 ms-md-4">
            <div class="events-filters p-3 rounded-3 bg-light">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label for="categoryFilter" class="form-label fw-bold mb-2 small">Filter by Category:</label>
                  <select id="categoryFilter" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="yearFilter" class="form-label fw-bold mb-2 small">Filter by Year:</label>
                  <select id="yearFilter" class="form-select form-select-sm">
                    <option value="">All Years</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button id="clearFilters" class="btn btn-sm btn-outline-secondary w-100">Clear Filters</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- List View -->
    <div id="listView" class="events-list-view">
      <div class="row" id="eventsGrid">
        {{ $events := where site.RegularPages "Section" "events" }}
        {{ $sortedEvents := sort $events "Date" "desc" }}
        {{ range $sortedEvents }}
        <div class="col-lg-4 col-md-6 mb-4 event-card-item" 
             data-category="{{ .Params.category | default "general" | lower | urlize }}"
             data-year="{{ .Date.Format "2006" }}">
          <div class="enhanced-event-card h-100 rounded-3 overflow-hidden shadow-sm">
            <div class="event-image-container position-relative">
              {{ if .Params.image }}
              {{ partial "image.html" (dict "Src" .Params.image "Alt" .Title "Class" "event-image" "Size" "400x250") }}
              {{ else }}
              <div class="event-image-placeholder">
                <i class="fas fa-calendar-alt text-muted" style="font-size: 3rem;"></i>
              </div>
              {{ end }}
              <div class="event-date-badge position-absolute top-0 start-0 m-3">
                <div class="date-day">{{ .Date.Format "2" }}</div>
                <div class="date-month">{{ .Date.Format "Jan" }}</div>
              </div>
              {{ if .Params.category }}
              <div class="event-category-badge position-absolute top-0 end-0 m-3">
                <span class="badge bg-primary">{{ .Params.category }}</span>
              </div>
              {{ end }}
            </div>
            <div class="event-content p-4">
              <div class="event-meta mb-3">
                <div class="event-time-location">
                  {{ if .Params.time }}
                  <span class="me-3">
                    <i class="far fa-clock text-primary me-2"></i>
                    <span class="small text-muted">{{ .Params.time }}</span>
                  </span>
                  {{ end }}
                  {{ if .Params.location }}
                  <span>
                    <i class="fas fa-map-marker-alt text-primary me-2"></i>
                    <span class="small text-muted">{{ .Params.location }}</span>
                  </span>
                  {{ end }}
                </div>
              </div>
              <h3 class="h5 mb-3 fw-bold">
                <a href="{{ .Permalink }}" class="text-dark text-decoration-none">{{ .Title }}</a>
              </h3>
              <p class="text-muted mb-3 small">{{ .Summary | truncate 120 }}</p>
              <div class="event-footer d-flex justify-content-between align-items-center">
                {{ if .Params.author }}
                <span class="small text-muted">
                  <i class="fas fa-user me-1"></i>{{ .Params.author }}
                </span>
                {{ end }}
                <a href="{{ .Permalink }}" class="btn btn-sm btn-outline-primary">Read More</a>
              </div>
            </div>
          </div>
        </div>
        {{ end }}
      </div>
      
      <!-- No Results Message -->
      <div id="noResults" class="row" style="display: none;">
        <div class="col-12 text-center py-5">
          <p class="text-muted">No events found matching your filters. Please try different criteria.</p>
        </div>
      </div>
    </div>
    
    <!-- Calendar View -->
    <div id="calendarView" class="events-calendar-view" style="display: none;">
      <div class="calendar-container">
        <div id="calendarWrapper" class="calendar-wrapper">
          <!-- Calendar will be generated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</section>
<!-- /Events Listing -->

<script>
(function() {
  // Get all event cards
  const eventCards = document.querySelectorAll('.event-card-item');
  const categoryFilter = document.getElementById('categoryFilter');
  const yearFilter = document.getElementById('yearFilter');
  const clearFiltersBtn = document.getElementById('clearFilters');
  const eventsGrid = document.getElementById('eventsGrid');
  const noResults = document.getElementById('noResults');
  const listView = document.getElementById('listView');
  const calendarView = document.getElementById('calendarView');
  const listViewBtn = document.getElementById('listViewBtn');
  const calendarViewBtn = document.getElementById('calendarViewBtn');
  
  if (!eventCards.length) return;
  
  // Collect unique categories and years
  const categories = new Set();
  const years = new Set();
  
  eventCards.forEach(card => {
    const category = card.getAttribute('data-category');
    if (category) categories.add(category);
    
    const year = card.getAttribute('data-year');
    if (year) years.add(year);
  });
  
  // Populate category filter
  Array.from(categories).sort().forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category.split('-').map(word => 
      word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
    categoryFilter.appendChild(option);
  });
  
  // Populate year filter (descending order)
  Array.from(years).sort((a, b) => b.localeCompare(a)).forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearFilter.appendChild(option);
  });
  
  // Filter function
  function filterEvents() {
    const selectedCategory = categoryFilter.value.toLowerCase();
    const selectedYear = yearFilter.value;
    
    let visibleCount = 0;
    
    eventCards.forEach(card => {
      const cardCategory = card.getAttribute('data-category').toLowerCase();
      const cardYear = card.getAttribute('data-year');
      
      const categoryMatch = !selectedCategory || cardCategory === selectedCategory;
      const yearMatch = !selectedYear || cardYear === selectedYear;
      
      if (categoryMatch && yearMatch) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });
    
    // Show/hide no results message
    if (visibleCount === 0) {
      eventsGrid.style.display = 'none';
      noResults.style.display = 'block';
    } else {
      eventsGrid.style.display = '';
      noResults.style.display = 'none';
    }
  }
  
  // View toggle
  function switchView(view) {
    if (view === 'list') {
      listView.style.display = '';
      calendarView.style.display = 'none';
      listViewBtn.classList.add('active');
      calendarViewBtn.classList.remove('active');
    } else {
      listView.style.display = 'none';
      calendarView.style.display = '';
      calendarViewBtn.classList.add('active');
      listViewBtn.classList.remove('active');
      generateCalendar();
    }
  }
  
  // Generate calendar view
  function generateCalendar() {
    const calendarWrapper = document.getElementById('calendarWrapper');
    const events = Array.from(eventCards).map(card => {
      const title = card.querySelector('h3 a')?.textContent || '';
      const link = card.querySelector('h3 a')?.href || '';
      const dateStr = card.getAttribute('data-year') + '-' + 
                     card.querySelector('.date-month')?.textContent + '-' + 
                     card.querySelector('.date-day')?.textContent;
      const category = card.getAttribute('data-category');
      return { title, link, dateStr, category, card };
    });
    
    // Simple calendar grid (this is a simplified version)
    calendarWrapper.innerHTML = '<div class="alert alert-info">Calendar view coming soon. For now, please use the list view.</div>';
  }
  
  // Event listeners
  categoryFilter.addEventListener('change', filterEvents);
  yearFilter.addEventListener('change', filterEvents);
  if (clearFiltersBtn) {
    clearFiltersBtn.addEventListener('click', function() {
      categoryFilter.value = '';
      yearFilter.value = '';
      filterEvents();
    });
  }
  
  listViewBtn.addEventListener('click', () => switchView('list'));
  calendarViewBtn.addEventListener('click', () => switchView('calendar'));
})();
</script>

{{ end }}
